# scx_flatcg 调度器评估报告

## 测试环境

| 项目 | 值 |
|------|-----|
| 内核版本 | Linux 6.15.11-061511-generic |
| CPU | 4 核 (online), 128 核 (possible) |
| cgroup 版本 | cgroup v2 |
| 测试日期 | 2026-02-07 |

## 测试项目

### 1. 权重公平性测试 (test_weight_fairness.sh)

**测试设计**：
- 创建 3 个 cgroup，权重分别为 100、200、300
- 每个 cgroup 运行 8 个 cpu_burn 进程
- 测试时长：10 秒

**预期结果**：
- cg_w100: 16.67% (100/600)
- cg_w200: 33.33% (200/600)
- cg_w300: 50.00% (300/600)

**实际结果**：

| Cgroup | 权重 | 预期 CPU% | 实际 CPU% | 偏差 |
|--------|------|-----------|-----------|------|
| cg_w100 | 100 | 16.67% | 16.57% | -0.10% |
| cg_w200 | 200 | 33.33% | 33.50% | +0.17% |
| cg_w300 | 300 | 50.00% | 49.93% | -0.07% |

**结论**：✅ 通过 - 最大偏差 0.17%，权重调度非常精确

### 2. 层级嵌套测试 (test_hierarchy.sh)

**测试设计**：
```
root
├── A (weight=100)
│   ├── B (weight=100)
│   └── C (weight=100)
└── D (weight=200)
```

**预期结果（权重扁平化）**：
- B: 1/6 = 16.67% （A 占 root 的 1/3，B 占 A 的 1/2）
- C: 1/6 = 16.67%
- D: 2/3 = 66.67%

**实际结果**：

| Cgroup | 预期 CPU% | 实际 CPU% | 偏差 |
|--------|-----------|-----------|------|
| A/B | 16.67% | 21.38% | +4.71% |
| A/C | 16.67% | 21.25% | +4.58% |
| D | 66.67% | 57.37% | -9.30% |

**分析**：
- B 和 C 获得了相近的 CPU 份额（符合预期）
- D 获得的份额低于预期，可能原因：
  - 每个 cgroup 只有 1 个进程，竞争不充分
  - 调度器初始化和 hweight 更新有一定延迟

**结论**：✅ 通过 - 最大偏差 9.30%（容忍阈值 15%），层级扁平化基本正确

### 3. 隔离性测试 (test_isolation.sh)

**测试设计**：
- victim cgroup：运行延迟敏感任务（latency_test）
- noisy cgroup：运行 4 个 cpu_burn 进程
- 对比 CFS 和 flatcg 下 victim 的 P99 延迟

**状态**：测试被中断，未完成

## 关键发现

### Bug 修复

发现并修复了一个严重 bug：在 `cpu_possible != cpu_online` 的系统上，所有任务被错误地路由到全局 fallback 队列，导致权重调度完全失效。

详见：[bug_analysis.md](./bug_analysis.md)

### flatcg 调度统计

修复后的调度器日志显示：

```
[SEQ      1 cpu=100.0 hweight_gen=228]
       act:   206  deact:   208 global:     0 local:    30
```

- `act/deact`: cgroup 活跃/非活跃切换次数
- `global`: 进入全局 fallback 队列的任务数
- `local`: 进入 cgroup 专属队列的任务数

修复后 `global: 0`，所有任务都正确进入了 cgroup 队列。

## 测试工具

### cpu_burn

简单的 CPU 密集型程序，用于测试 CPU 公平分配：

```c
while (running) {
    for (int i = 0; i < 1000000; i++) {
        iterations++;
        __asm__ volatile("" ::: "memory");
    }
}
```

### latency_test

延迟测量程序，用于测试调度延迟：
- 周期性 sleep 并测量唤醒延迟
- 输出 min/max/avg/p50/p95/p99 指标

## 总结

| 测试 | 状态 | 最大偏差 |
|------|------|----------|
| 权重公平性 | ✅ 通过 | 0.17% |
| 层级嵌套 | ✅ 通过 | 9.30% |
| 隔离性 | ⏸️ 未完成 | - |

scx_flatcg 调度器在修复 CPU 数量不匹配 bug 后，能够正确地按照 cgroup 权重分配 CPU 资源，层级扁平化算法也基本符合预期。

## 后续工作

1. 完成隔离性测试，对比 CFS 和 flatcg 的延迟表现
2. 增加更多进程数以获得更精确的权重比例
3. 测试 CPU 热插拔场景
4. 向上游报告 possible vs online CPU bug
