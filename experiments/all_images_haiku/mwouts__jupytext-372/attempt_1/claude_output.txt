
=== GIT DIFF ===
diff --git a/jupytext/magics.py b/jupytext/magics.py
index cf38d4b..f19588e 100644
--- a/jupytext/magics.py
+++ b/jupytext/magics.py
@@ -21,14 +21,14 @@ _MAGIC_FORCE_ESC_RE['rust'] = re.compile(r"^(// |//)*:[a-zA-Z](.*)//\s*escape")
 _MAGIC_FORCE_ESC_RE['rust'] = re.compile(r"^(// |//)*:[a-zA-Z](.*)//\s*noescape")
 
 # Commands starting with a question or exclamation mark have to be escaped
-_PYTHON_HELP_OR_BASH_CMD = re.compile(r"^(# |#)*(\?|!)\s*[A-Za-z]")
+_PYTHON_HELP_OR_BASH_CMD = re.compile(r"^(# |#)*(([a-zA-Z_][a-zA-Z0-9_]*)?(\?)(?![a-zA-Z0-9_])|!)\s*[A-Za-z]")
 
 # A bash command not followed by an equal sign or a parenthesis is a magic command
 _PYTHON_MAGIC_CMD = re.compile(r"^(# |#)*({})($|\s$|\s[^=,])".format('|'.join(
     # posix
     ['cat', 'cp', 'mv', 'rm', 'rmdir', 'mkdir'] +
     # windows
-    ['copy', 'ddir', 'echo', 'ls', 'ldir', 'mkdir', 'ren', 'rmdir'])))
+    ['copy', 'ddir', 'echo', 'ls', 'ldir', 'ren', 'rmdir'])))
 
 _SCRIPT_LANGUAGES = [_SCRIPT_EXTENSIONS[ext]['language'] for ext in _SCRIPT_EXTENSIONS]
 
@@ -45,9 +45,11 @@ def is_magic(line, language, global_escape_flag=True):
         return True
     if language != 'python':
         return False
-    if _PYTHON_HELP_OR_BASH_CMD.match(line):
+    # Normalize the line by removing existing comments
+    normalized_line = line.lstrip('# ')
+    if _PYTHON_HELP_OR_BASH_CMD.match(normalized_line):
         return True
-    return _PYTHON_MAGIC_CMD.match(line)
+    return _PYTHON_MAGIC_CMD.match(normalized_line) is not None
 
 
 def comment_magic(source, language='python', global_escape_flag=True):
@@ -56,6 +58,7 @@ def comment_magic(source, language='python', global_escape_flag=True):
     next_is_magic = False
     for pos, line in enumerate(source):
         if not parser.is_quoted() and (next_is_magic or is_magic(line, language, global_escape_flag)):
+            # Always add '#' in front of magic comments
             source[pos] = _COMMENT[language] + ' ' + line
             next_is_magic = language == 'python' and _LINE_CONTINUATION_RE.match(line)
         parser.read_line(line)
=== DISK USAGE ===
47	/testbed
