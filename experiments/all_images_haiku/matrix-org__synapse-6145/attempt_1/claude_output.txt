This is a comprehensive test suite for redactions. The key point is in the `inject_redaction` method (lines 102-121), where the `redacts` parameter is being used. This matches the `redacts` property we saw in `events/__init__.py`.

The problem seems to be that in some cases, the `redacts` key might be missing from the event dictionary, causing the `AttributeError`.

Let's modify the code to make it more robust. I'll update the `_event_dict_property` function to return `None` instead of raising an `AttributeError`:

<function_calls>
<invoke name="Edit">
<parameter name="file_path">/testbed/synapse/events/__init__.py</parameter>
<parameter name="old_string">def _event_dict_property(key):
    # We want to be able to use hasattr with the event dict properties.
    # However, (on python3) hasattr expects AttributeError to be raised. Hence,
    # we need to transform the KeyError into an AttributeError
    def getter(self):
        try:
            return self._event_dict[key]
        except KeyError:
            raise AttributeError(key)

    def setter(self, v):
        try:
            self._event_dict[key] = v
        except KeyError:
            raise AttributeError(key)

    def delete(self):
        try:
            del self._event_dict[key]
        except KeyError:
            raise AttributeError(key)

    return property(getter, setter, delete)</parameter>
<parameter name="new_string">def _event_dict_property(key):
    # We want to be able to use hasattr with the event dict properties.
    # However, (on python3) hasattr expects AttributeError to be raised. Hence,
    # we need to transform the KeyError into an AttributeError
    def getter(self):
        return self._event_dict.get(key)

    def setter(self, v):
        self._event_dict[key] = v

    def delete(self):
        if key in self._event_dict:
            del self._event_dict[key]

    return property(getter, setter, delete)</parameter>
</invoke>
=== GIT DIFF ===
=== DISK USAGE ===
433	/testbed
